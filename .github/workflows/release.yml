name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.2.1
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git commit hash
    
    - name: Install MinGW
      uses: egor-tensin/setup-mingw@v2
      with:
        platform: x64
        version: 12.2.0
    
    - name: Download SDL2
      shell: powershell
      run: |
        # Download SDL2 development libraries
        $sdlVersion = "2.30.9"
        $sdlUrl = "https://github.com/libsdl-org/SDL/releases/download/release-$sdlVersion/SDL2-devel-$sdlVersion-mingw.zip"
        Invoke-WebRequest -Uri $sdlUrl -OutFile "SDL2.zip"
        Expand-Archive -Path "SDL2.zip" -DestinationPath "."
        
        # Copy to expected location
        New-Item -ItemType Directory -Force -Path "lib"
        New-Item -ItemType Directory -Force -Path "bin"
        Copy-Item "SDL2-$sdlVersion\x86_64-w64-mingw32\lib\*" -Destination "lib\" -Recurse
        Copy-Item "SDL2-$sdlVersion\x86_64-w64-mingw32\bin\SDL2.dll" -Destination "bin\" -Force
        
        # Copy headers
        New-Item -ItemType Directory -Force -Path "include\SDL2"
        Copy-Item "SDL2-$sdlVersion\x86_64-w64-mingw32\include\SDL2\*" -Destination "include\SDL2\" -Recurse
    
    - name: Download KissFFT
      shell: powershell
      run: |
        # Download KissFFT
        $kissfftUrl = "https://github.com/mborgerding/kissfft/archive/refs/tags/v131.zip"
        Invoke-WebRequest -Uri $kissfftUrl -OutFile "kissfft.zip"
        Expand-Archive -Path "kissfft.zip" -DestinationPath "."
        
        # Copy to expected location
        New-Item -ItemType Directory -Force -Path "lib\kissfft"
        Copy-Item "kissfft-131\kiss_fft.h" -Destination "lib\kissfft\"
        Copy-Item "kissfft-131\kiss_fft.c" -Destination "lib\kissfft\"
    
    - name: Setup SDRplay API headers (stub)
      shell: powershell
      run: |
        # Note: SDRplay API requires manual installation on end-user machines
        # For CI, we create stub headers to allow compilation
        # The actual API DLL must be installed separately
        
        New-Item -ItemType Directory -Force -Path "include\sdrplay"
        New-Item -ItemType Directory -Force -Path "lib"
        
        # Create comprehensive stub header for compilation
        @"
        // SDRplay API v3.x stub for CI builds
        // Real API: https://www.sdrplay.com/api/
        #ifndef SDRPLAY_API_H
        #define SDRPLAY_API_H
        
        #include <stdint.h>
        
        #ifdef __cplusplus
        extern "C" {
        #endif
        
        // Error codes
        typedef enum {
            sdrplay_api_Success = 0,
            sdrplay_api_Fail = 1,
            sdrplay_api_InvalidParam = 2,
            sdrplay_api_OutOfRange = 3,
            sdrplay_api_GainUpdateError = 4,
            sdrplay_api_RfUpdateError = 5,
            sdrplay_api_FsUpdateError = 6,
            sdrplay_api_HwError = 7,
            sdrplay_api_AliasingError = 8,
            sdrplay_api_AlreadyInitialised = 9,
            sdrplay_api_NotInitialised = 10,
            sdrplay_api_NotEnabled = 11,
            sdrplay_api_HwVerError = 12,
            sdrplay_api_OutOfMemError = 13,
            sdrplay_api_ServiceNotResponding = 14,
            sdrplay_api_StartPending = 15,
            sdrplay_api_StopPending = 16,
            sdrplay_api_InvalidMode = 17,
            sdrplay_api_FailedVerification1 = 18,
            sdrplay_api_FailedVerification2 = 19,
            sdrplay_api_FailedVerification3 = 20,
            sdrplay_api_FailedVerification4 = 21,
            sdrplay_api_FailedVerification5 = 22,
            sdrplay_api_FailedVerification6 = 23,
            sdrplay_api_InvalidServiceVersion = 24
        } sdrplay_api_ErrT;
        
        typedef enum {
            sdrplay_api_DbgLvl_Disable = 0,
            sdrplay_api_DbgLvl_Verbose = 1,
            sdrplay_api_DbgLvl_Warning = 2,
            sdrplay_api_DbgLvl_Error = 3,
            sdrplay_api_DbgLvl_Message = 4
        } sdrplay_api_DbgLvl_t;
        
        typedef enum {
            sdrplay_api_TunerA = 0,
            sdrplay_api_TunerB = 1,
            sdrplay_api_Tuner_Both = 2
        } sdrplay_api_TunerSelectT;
        
        typedef enum {
            sdrplay_api_IF_Undefined = -1,
            sdrplay_api_IF_Zero = 0,
            sdrplay_api_IF_0_450 = 1,
            sdrplay_api_IF_1_620 = 2,
            sdrplay_api_IF_2_048 = 3
        } sdrplay_api_If_kHzT;
        
        typedef enum {
            sdrplay_api_BW_Undefined = 0,
            sdrplay_api_BW_0_200 = 200,
            sdrplay_api_BW_0_300 = 300,
            sdrplay_api_BW_0_600 = 600,
            sdrplay_api_BW_1_536 = 1536,
            sdrplay_api_BW_5_000 = 5000,
            sdrplay_api_BW_6_000 = 6000,
            sdrplay_api_BW_7_000 = 7000,
            sdrplay_api_BW_8_000 = 8000
        } sdrplay_api_Bw_MHzT;
        
        typedef enum {
            sdrplay_api_AgcMode_DISABLE = 0,
            sdrplay_api_AgcMode_5HZ = 1,
            sdrplay_api_AgcMode_50HZ = 2,
            sdrplay_api_AgcMode_100HZ = 3,
            sdrplay_api_AgcMode_CTRL_AGC = 4
        } sdrplay_api_AgcControlT;
        
        typedef enum {
            sdrplay_api_EXTENDED_MIN_GR = 0,
            sdrplay_api_NORMAL_MIN_GR = 20
        } sdrplay_api_MinGainReductionT;
        
        typedef enum {
            sdrplay_api_Update_None = 0x00000000,
            sdrplay_api_Update_Dev_Fs = 0x00000001,
            sdrplay_api_Update_Dev_Ppm = 0x00000002,
            sdrplay_api_Update_Dev_SyncUpdate = 0x00000004,
            sdrplay_api_Update_Dev_ResetFlags = 0x00000008,
            sdrplay_api_Update_Rsp1a_BiasTControl = 0x00000010,
            sdrplay_api_Update_Rsp1a_RfNotchControl = 0x00000020,
            sdrplay_api_Update_Rsp1a_RfDabNotchControl = 0x00000040,
            sdrplay_api_Update_Rsp2_BiasTControl = 0x00000080,
            sdrplay_api_Update_Rsp2_AmPortSelect = 0x00000100,
            sdrplay_api_Update_Rsp2_AntennaControl = 0x00000200,
            sdrplay_api_Update_Rsp2_RfNotchControl = 0x00000400,
            sdrplay_api_Update_Rsp2_ExtRefControl = 0x00000800,
            sdrplay_api_Update_RspDuo_ExtRefControl = 0x00001000,
            sdrplay_api_Update_Master_Spare_1 = 0x00002000,
            sdrplay_api_Update_Master_Spare_2 = 0x00004000,
            sdrplay_api_Update_Tuner_Gr = 0x00008000,
            sdrplay_api_Update_Tuner_GrLimits = 0x00010000,
            sdrplay_api_Update_Tuner_Frf = 0x00020000,
            sdrplay_api_Update_Tuner_BwType = 0x00040000,
            sdrplay_api_Update_Tuner_IfType = 0x00080000,
            sdrplay_api_Update_Tuner_DcOffset = 0x00100000,
            sdrplay_api_Update_Tuner_LoMode = 0x00200000,
            sdrplay_api_Update_Ctrl_DCoffsetIQimbalance = 0x00400000,
            sdrplay_api_Update_Ctrl_Decimation = 0x00800000,
            sdrplay_api_Update_Ctrl_Agc = 0x01000000,
            sdrplay_api_Update_Ctrl_AdsbMode = 0x02000000,
            sdrplay_api_Update_Ctrl_OverloadMsgAck = 0x04000000,
            sdrplay_api_Update_RspDuo_BiasTControl = 0x08000000,
            sdrplay_api_Update_RspDuo_AmPortSelect = 0x10000000,
            sdrplay_api_Update_RspDuo_Tuner1AmNotchControl = 0x20000000,
            sdrplay_api_Update_RspDuo_RfNotchControl = 0x40000000,
            sdrplay_api_Update_RspDuo_RfDabNotchControl = 0x80000000
        } sdrplay_api_ReasonForUpdateT;
        
        typedef enum {
            sdrplay_api_Update_Ext1_None = 0x00000000
        } sdrplay_api_ReasonForUpdateExtension1T;
        
        typedef enum {
            sdrplay_api_GainChange = 0,
            sdrplay_api_PowerOverloadChange = 1,
            sdrplay_api_DeviceRemoved = 2,
            sdrplay_api_RspDuoModeChange = 3
        } sdrplay_api_EventT;
        
        typedef enum {
            sdrplay_api_Overload_Detected = 0,
            sdrplay_api_Overload_Corrected = 1
        } sdrplay_api_PowerOverloadChangeTypeT;
        
        typedef struct {
            uint32_t gRdB;
            uint32_t lnaGRdB;
            double currGain;
        } sdrplay_api_GainCbParamT;
        
        typedef struct {
            sdrplay_api_PowerOverloadChangeTypeT powerOverloadChangeType;
        } sdrplay_api_PowerOverloadCbParamT;
        
        typedef struct {
            uint32_t gRdB;
            uint32_t lnaState;
            sdrplay_api_GainCbParamT gainParams;
            sdrplay_api_PowerOverloadCbParamT powerOverloadParams;
        } sdrplay_api_EventParamsT;
        
        typedef struct {
            uint32_t fsHz;
            uint8_t syncUpdate;
            uint8_t reCal;
        } sdrplay_api_StreamCbParamsT;
        
        typedef struct {
            void *dev;
            char SerNo[256];
            unsigned char hwVer;
            unsigned char devAvail;
        } sdrplay_api_DeviceT;
        
        typedef struct {
            double rfHz;
            sdrplay_api_Bw_MHzT bwType;
            sdrplay_api_If_kHzT ifType;
            sdrplay_api_MinGainReductionT minGr;
            unsigned char gainReductionDb;
        } sdrplay_api_TunerParamsT;
        
        typedef struct {
            unsigned char DCenable;
            unsigned char IQenable;
        } sdrplay_api_DcOffsetTunerT;
        
        typedef struct {
            unsigned char enable;
            unsigned char decimationFactor;
            unsigned char wideBandSignal;
        } sdrplay_api_DecimationT;
        
        typedef struct {
            sdrplay_api_AgcControlT enable;
            int setPoint_dBfs;
            unsigned short attack_ms;
            unsigned short decay_ms;
            unsigned short decay_delay_ms;
            unsigned short decay_threshold_dB;
            int syncUpdate;
        } sdrplay_api_AgcT;
        
        typedef struct {
            sdrplay_api_DcOffsetTunerT dcOffset;
            sdrplay_api_DecimationT decimation;
            sdrplay_api_AgcT agc;
        } sdrplay_api_ControlParamsT;
        
        typedef struct {
            sdrplay_api_TunerParamsT tunerParams;
            sdrplay_api_ControlParamsT ctrlParams;
        } sdrplay_api_RxChannelParamsT;
        
        typedef struct {
            double ppm;
            uint32_t fsHz;
            uint8_t syncUpdate;
            uint8_t reCal;
        } sdrplay_api_DevParamsT;
        
        typedef struct {
            sdrplay_api_DevParamsT devParams;
            sdrplay_api_RxChannelParamsT *rxChannelA;
            sdrplay_api_RxChannelParamsT *rxChannelB;
        } sdrplay_api_DeviceParamsT;
        
        typedef void (*sdrplay_api_StreamCallback_t)(short *xi, short *xq, 
            sdrplay_api_StreamCbParamsT *params, unsigned int numSamples, 
            unsigned int reset, void *cbContext);
        
        typedef void (*sdrplay_api_EventCallback_t)(sdrplay_api_EventT eventId, 
            sdrplay_api_TunerSelectT tuner, sdrplay_api_EventParamsT *params, 
            void *cbContext);
        
        typedef struct {
            sdrplay_api_StreamCallback_t StreamACbFn;
            sdrplay_api_StreamCallback_t StreamBCbFn;
            sdrplay_api_EventCallback_t EventCbFn;
        } sdrplay_api_CallbackFnsT;
        
        // Stub function declarations (will not link without real DLL)
        sdrplay_api_ErrT sdrplay_api_Open(void);
        sdrplay_api_ErrT sdrplay_api_Close(void);
        sdrplay_api_ErrT sdrplay_api_ApiVersion(float *apiVer);
        sdrplay_api_ErrT sdrplay_api_LockDeviceApi(void);
        sdrplay_api_ErrT sdrplay_api_UnlockDeviceApi(void);
        sdrplay_api_ErrT sdrplay_api_GetDevices(sdrplay_api_DeviceT *devices, 
            unsigned int *numDevs, unsigned int maxDevs);
        sdrplay_api_ErrT sdrplay_api_SelectDevice(sdrplay_api_DeviceT *device);
        sdrplay_api_ErrT sdrplay_api_ReleaseDevice(sdrplay_api_DeviceT *device);
        const char* sdrplay_api_GetErrorString(sdrplay_api_ErrT err);
        sdrplay_api_ErrT sdrplay_api_DebugEnable(void *dev, sdrplay_api_DbgLvl_t dbgLvl);
        sdrplay_api_ErrT sdrplay_api_GetDeviceParams(void *dev, 
            sdrplay_api_DeviceParamsT **deviceParams);
        sdrplay_api_ErrT sdrplay_api_Init(void *dev, sdrplay_api_CallbackFnsT *cbFns, 
            void *cbContext);
        sdrplay_api_ErrT sdrplay_api_Uninit(void *dev);
        sdrplay_api_ErrT sdrplay_api_Update(void *dev, sdrplay_api_TunerSelectT tuner,
            sdrplay_api_ReasonForUpdateT reasonForUpdate, 
            sdrplay_api_ReasonForUpdateExtension1T reasonForUpdateExt1);
        
        #ifdef __cplusplus
        }
        #endif
        
        #endif // SDRPLAY_API_H
        "@ | Out-File -FilePath "include\sdrplay\sdrplay_api.h" -Encoding UTF8
        
        # Create stub library file
        @"
        LIBRARY sdrplay_api
        EXPORTS
            sdrplay_api_Open
            sdrplay_api_Close
            sdrplay_api_GetDevices
            sdrplay_api_SelectDevice
            sdrplay_api_GetDeviceParams
            sdrplay_api_Init
            sdrplay_api_Uninit
            sdrplay_api_Update
            sdrplay_api_GetErrorString
        "@ | Out-File -FilePath "lib\sdrplay_api.def" -Encoding UTF8
        
        Write-Host "Note: SDRplay API stub created. Binaries will compile but require real DLL to run."
    
    - name: Build Release
      shell: powershell
      run: |
        # Build with release optimizations
        .\.github\ci_build.ps1 -Release
    
    - name: Package Release
      shell: powershell
      run: |
        # Get version from tag or version.h
        $version = if ($env:GITHUB_REF_NAME) { $env:GITHUB_REF_NAME } else { "dev" }
        
        # Create release package
        $packageName = "phoenix_sdr-$version-win64"
        New-Item -ItemType Directory -Force -Path "release\$packageName"
        
        # Copy executables
        Copy-Item "bin\*.exe" -Destination "release\$packageName\" -ErrorAction SilentlyContinue
        
        # Copy required DLLs
        Copy-Item "bin\SDL2.dll" -Destination "release\$packageName\" -ErrorAction SilentlyContinue
        
        # Copy documentation
        Copy-Item "README.md" -Destination "release\$packageName\" -ErrorAction SilentlyContinue
        Copy-Item "docs\BETA_TESTING_GUIDE.md" -Destination "release\$packageName\" -ErrorAction SilentlyContinue
        
        # Create zip
        Compress-Archive -Path "release\$packageName" -DestinationPath "release\$packageName.zip"
        
        Write-Host "Created release package: release\$packageName.zip"
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: phoenix_sdr-build
        path: release/*.zip
        retention-days: 30
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: release/*.zip
        draft: false
        prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
